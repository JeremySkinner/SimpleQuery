namespace SimpleQuery {
	using System;
	using System.Linq.Expressions;
	using System.Reflection;

	public class PropertyMetadata<T> {
		private readonly Action<T, object> setter;
		private readonly PropertyInfo property;
		private readonly Func<T, object> getter;

		public PropertyMetadata(PropertyInfo property) {
			this.property = property;
			this.setter = BuildSetterDelegate(property);
			this.getter = BuildGetterDelegate(property);
			PropertyName = MapPropertyName(property);

			var keyAttr = (KeyAttribute)Attribute.GetCustomAttribute(property, typeof (KeyAttribute));

			IsId = 
				keyAttr != null || 
				property.Name == "Id" || property.Name == "ID";

			IsAutoGenerated = IsId;

			if(keyAttr != null && keyAttr.Generated == false) {
				IsAutoGenerated = false;
			}

		}

		static string MapPropertyName(PropertyInfo property) {
			var attribute = (ColumnAttribute)Attribute.GetCustomAttribute(property, typeof(ColumnAttribute));
			if(attribute==null) return property.Name;
			return attribute.Name;
		}

		public bool IsId { get; private set; }

		public PropertyInfo Property {
			get { return property; }
		}

		public string PropertyName { 
			get; protected set; 
		}

		public bool IsAutoGenerated { get; internal set; }

		public void SetValue(T instance, object value) {
			setter(instance, value);
		}

		public object GetValue(T instance) {
			return getter(instance);
		}

		private static Action<T, object> BuildSetterDelegate(PropertyInfo prop) {
			var instance = Expression.Parameter(typeof(T), "x");
			var argument = Expression.Parameter(typeof(object), "v");

			var setterCall = Expression.Call(
				instance,
				prop.GetSetMethod(true),
				Expression.Convert(argument, prop.PropertyType));

			return (Action<T, object>)Expression.Lambda(setterCall, instance, argument).Compile();
		}

		private Func<T, object> BuildGetterDelegate(PropertyInfo prop) {
			var param = Expression.Parameter(typeof(T), "x");
			Expression expression = Expression.PropertyOrField(param, prop.Name);

			if (prop.PropertyType.IsValueType)
				expression = Expression.Convert(expression, typeof(object));

			return Expression.Lambda<Func<T, object>>(expression, param)
				.Compile();
		}


	}
}